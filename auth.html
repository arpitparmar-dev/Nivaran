<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import {
  getAuth,
  createUserWithEmailAndPassword,
  signInWithEmailAndPassword,
  setPersistence,
  browserLocalPersistence,
  browserSessionPersistence,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCKav6YcbmYnX0OkzdDabF3SonOKB_BW-s",
  authDomain: "nivaran-62268.firebaseapp.com",
  projectId: "nivaran-62268",
  storageBucket: "nivaran-62268.firebasestorage.app",
  messagingSenderId: "435713174677",
  appId: "1:435713174677:web:06f681ab823906f6ccff9c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

let mode = "login";

// --- UPDATED LOGIC ---
onAuthStateChanged(auth, (user) => {
  // Check if the user is on this page because they just clicked "Sign Out"
  const isLoggingOut = sessionStorage.getItem("logging_out");

  if (user && !isLoggingOut) {
    // If they are logged in and NOT logging out, go to dashboard
    window.location.replace("progress.html");
  } else {
    // If they logged out, clear the flag so they can log in again later
    sessionStorage.removeItem("logging_out");
    // Show the card (if you added the flicker-fix)
    document.querySelector('.card').style.display = "block";
  }
});

window.toggleMode = function(){
  mode = mode === "login" ? "signup" : "login";
  document.getElementById("title").innerText = mode === "login" ? "Login" : "Sign Up";
  document.getElementById("confirmPassword").style.display = mode === "signup" ? "block" : "none";
  document.getElementById("authBtn").innerText = mode === "login" ? "Login" : "Sign Up";
  document.getElementById("toggleText").innerText = mode === "login" ? "New user? Sign up" : "Have an account? Login";
  document.getElementById("rememberBox").style.display = mode === "login" ? "flex" : "none";
  document.getElementById("error").innerText = "";
};

window.submitAuth = async function(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const rememberMe = document.getElementById("rememberMe").checked;
  const errorDiv = document.getElementById("error");
  const authBtn = document.getElementById("authBtn");

  if(!email || !password) {
      errorDiv.innerText = "Please fill in all fields";
      return;
  }

  authBtn.disabled = true;

  try{
    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
    await setPersistence(auth, persistence);

    if(mode === "signup"){
      const confirmPassword = document.getElementById("confirmPassword").value;
      if(password !== confirmPassword){
        errorDiv.innerText = "Passwords do not match";
        authBtn.disabled = false;
        return;
      }
      await createUserWithEmailAndPassword(auth, email, password);
    } else {
      await signInWithEmailAndPassword(auth, email, password);
    }
  } catch(e) {
    errorDiv.innerText = e.message;
    authBtn.disabled = false;
  }
};

window.guestLogin = function(){
  sessionStorage.setItem("guest", "true");
  window.location.replace("progress.html");
};
</script>
