<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NIVARAN Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<style>
:root{
    --primary:#2A1503;
    --secondary:#66350F;
    --bg:#F5F5DC;
    --card:#C2B280;
    --accent:#E8D8C4;
    --shield:#1cb0f6;
    --danger: #962d2d;
}

*{box-sizing:border-box; font-family:"Segoe UI",sans-serif; transition: 0.3s;}
body{ margin:0; background:var(--bg); color:var(--primary); overflow-x:hidden; }

/* üå∏ MANDALA ANIMATIONS */
.flower-bg{ position:fixed; inset:0; z-index:-1; pointer-events:none; }
.mandala{ position:absolute; width:950px; height:950px; opacity:0.25; animation: flowerSpin 220s linear infinite; }
.mandala.left{ top:-250px; left:-250px; }
.mandala.right{ bottom:-250px; right:-250px; animation-duration:260s; }
@keyframes flowerSpin{ from{ transform:rotate(0deg); } to{ transform:rotate(360deg); } }

/* SIDEBAR & PROFILE */
#menuIcon{ position:fixed; top:20px; left:20px; font-size:26px; cursor:pointer; z-index:2001; }
#sidebarOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); display: none; z-index: 1999; backdrop-filter: blur(2px); }
#sidebar { 
    position: fixed; top: 0; left: -320px; width: 300px; height: 100vh; 
    background: var(--card); padding: 40px 20px; transition: 0.4s; 
    z-index: 2000; border-right: 2px solid var(--secondary); overflow-y: auto;
    display: flex; flex-direction: column;
}
#sidebar.open { left: 0; }
.profile-container { position: relative; width: 90px; height: 90px; margin: 0 auto 15px; }
.profile-img { width: 100%; height: 100%; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; border: 3px solid var(--secondary); overflow: hidden; position: relative; z-index: 2; }
.profile-img img { width: 100%; height: 100%; object-fit: cover; }
.profile-effect { position: absolute; top: -5px; left: -5px; width: 100px; height: 100px; border-radius: 50%; z-index: 1; box-shadow: 0 0 25px 12px rgba(255, 152, 0, 0.6); animation: pulseFire 1.2s infinite; }

/* PROGRESS BARS */
.mini-progress-bg { width: 100%; height: 8px; background: var(--accent); border-radius: 10px; margin-top: 5px; overflow: hidden; }
.mini-progress-fill { height: 100%; background: var(--secondary); width: 0%; transition: width 0.8s; }
.recovery-label { font-size: 10px; font-weight: bold; display: flex; justify-content: space-between; margin-top: 15px; text-transform: uppercase; }

/* üõ†Ô∏è SIDEBAR BUTTONS (Uniform Size) */
.sidebar-action-btn {
    width: 100%;
    padding: 14px;
    font-size: 12px;
    border-radius: 12px;
    background: var(--danger);
    color: white;
    border: none;
    font-weight: bold;
    cursor: pointer;
    margin-top: 10px;
    text-transform: uppercase;
    display: block;
}
.sidebar-action-btn:hover { background: #7a2424; transform: scale(1.02); }

/* DASHBOARD CARDS (Border-Left Style) */
.container{ max-width:800px; margin:auto; padding:80px 20px 20px; }
.card{ background:var(--card); padding:16px; border-radius:18px; margin-bottom:15px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
.addiction-btn{ cursor:pointer; border-left:6px solid var(--secondary); transition: 0.2s; text-align: left; }
.addiction-btn:hover { transform: translateX(8px); background: var(--accent); }

/* üõ†Ô∏è CENTERED STATS & TROPHY */
.stats-row { 
    display: flex; 
    justify-content: center; 
    gap: 20px; 
    margin-bottom: 25px; 
    width: 100%;
}
.stat-circle {
    width: 85px; height: 85px; border-radius: 50%;
    background: var(--accent); border: 3px solid var(--secondary);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
.stat-value { font-size: 24px; font-weight: bold; line-height: 1; }
.stat-label { font-size: 10px; text-transform: uppercase; opacity: 0.7; }

.trophy-zone { 
    display: flex;
    flex-direction: column;
    align-items: center; 
    justify-content: center;
    text-align: center; 
    margin-bottom: 20px; 
}
.shield-badge { 
    background: var(--shield); 
    color: white; 
    padding: 6px 15px; 
    border-radius: 20px; 
    font-weight: bold; 
    display: inline-flex; 
    align-items: center; 
    justify-content: center;
    gap: 8px; 
    margin: 0 auto 15px;
}

/* TASKS & MODALS */
.task-row{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; margin-bottom:8px; background:rgba(255,255,255,0.3); }
.task-row input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--secondary); }
.update-btn{ width:100%; padding:16px; font-size:18px; border-radius:12px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
.nav-btn { background: var(--accent); color: var(--primary); padding: 8px 15px; border-radius: 8px; border: 1px solid var(--secondary); font-weight: bold; cursor: pointer; }
.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 4000; display: none; align-items: center; justify-content: center; }
.modal-card { background: var(--bg); padding: 25px; border-radius: 20px; text-align: center; width: 320px; border: 2px solid var(--secondary); }
</style>
</head>

<body onload="initApp()">

<div class="flower-bg">
    <svg class="mandala left" viewBox="0 0 800 800">
      <defs><path id="petal" d="M0,-220 C80,-170 80,-70 0,-40 C-80,-70 -80,-170 0,-220"/></defs>
      <g transform="translate(400 400)" fill="none" stroke="#C2A878" stroke-width="2">
        <circle r="280"/><circle r="240"/><circle r="120"/>
        <use href="#petal"/><use href="#petal" transform="rotate(20)"/><use href="#petal" transform="rotate(40)"/><use href="#petal" transform="rotate(60)"/><use href="#petal" transform="rotate(80)"/><use href="#petal" transform="rotate(100)"/><use href="#petal" transform="rotate(120)"/><use href="#petal" transform="rotate(140)"/><use href="#petal" transform="rotate(160)"/><use href="#petal" transform="rotate(180)"/><use href="#petal" transform="rotate(200)"/><use href="#petal" transform="rotate(220)"/><use href="#petal" transform="rotate(240)"/><use href="#petal" transform="rotate(260)"/><use href="#petal" transform="rotate(280)"/><use href="#petal" transform="rotate(300)"/><use href="#petal" transform="rotate(320)"/><use href="#petal" transform="rotate(340)"/>
      </g>
    </svg>
    <svg class="mandala right" viewBox="0 0 800 800">
      <g transform="translate(400 400)" fill="none" stroke="#C2A878" stroke-width="2">
        <circle r="280"/><circle r="240"/><circle r="120"/>
        <use href="#petal"/><use href="#petal" transform="rotate(20)"/><use href="#petal" transform="rotate(40)"/><use href="#petal" transform="rotate(60)"/><use href="#petal" transform="rotate(80)"/><use href="#petal" transform="rotate(100)"/><use href="#petal" transform="rotate(120)"/><use href="#petal" transform="rotate(140)"/><use href="#petal" transform="rotate(160)"/><use href="#petal" transform="rotate(180)"/><use href="#petal" transform="rotate(200)"/><use href="#petal" transform="rotate(220)"/><use href="#petal" transform="rotate(240)"/><use href="#petal" transform="rotate(260)"/><use href="#petal" transform="rotate(280)"/><use href="#petal" transform="rotate(300)"/><use href="#petal" transform="rotate(320)"/><use href="#petal" transform="rotate(340)"/>
      </g>
    </svg>
</div>

<div id="menuIcon" onclick="toggleSidebar()">‚ò∞</div>
<div id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div id="sidebar">
  <div id="profileDisplay" style="text-align:center;">
    <button onclick="toggleProfileEdit()" style="float:right; background:none; border:none; cursor:pointer; font-size:20px;">‚öôÔ∏è</button>
    <div class="profile-container">
        <div class="profile-effect"></div>
        <div id="userAvatar" class="profile-img">üë§</div>
    </div>
    <h3 id="currentUserName">Guest</h3>
  </div>

  <div id="sidebarEditSection" style="display:none;" class="card">
    <h4 style="margin:0;">Edit Profile</h4>
    <input type="text" id="editName" placeholder="Name" style="width:100%; padding:8px; margin:8px 0; border-radius:5px; border:1px solid #ccc;">
    <input type="number" id="editHeight" placeholder="Height (cm)" style="width:100%; padding:8px; margin-bottom:8px; border-radius:5px; border:1px solid #ccc;">
    <input type="number" id="editWeight" placeholder="Weight (kg)" style="width:100%; padding:8px; margin-bottom:8px; border-radius:5px; border:1px solid #ccc;">
    <button class="nav-btn" onclick="document.getElementById('imgInput').click()" style="width:100%; margin-bottom:10px; font-size:12px;">Upload Photo</button>
    <input type="file" id="imgInput" style="display:none" accept="image/*" onchange="previewSidebarImg(this)">
    <div style="display:flex; gap:5px;">
        <button class="update-btn" style="padding:8px; font-size:12px;" onclick="saveSidebarProfile()">Save</button>
        <button class="update-btn" style="padding:8px; font-size:12px; background:#444;" onclick="toggleProfileEdit()">Cancel</button>
    </div>
  </div>

  <div id="sidebarStats">
      <div class="recovery-label"><span>Mobile</span><span id="pct-sm">0%</span></div>
      <div class="mini-progress-bg"><div id="bar-sm" class="mini-progress-fill"></div></div>
      <div class="recovery-label"><span>Smoking</span><span id="pct-sa">0%</span></div>
      <div class="mini-progress-bg"><div id="bar-sa" class="mini-progress-fill"></div></div>
      <div class="recovery-label"><span>Gaming</span><span id="pct-gm">0%</span></div>
      <div class="mini-progress-bg"><div id="bar-gm" class="mini-progress-fill"></div></div>
      <div class="recovery-label"><span>Food</span><span id="pct-jf">0%</span></div>
      <div class="mini-progress-bg"><div id="bar-jf" class="mini-progress-fill"></div></div>
  </div>

  <div style="margin-top: auto; padding-top: 20px;">
      <button class="sidebar-action-btn" onclick="showResetModal()">‚ö†Ô∏è RESET ALL PROGRESS</button>
      <button class="sidebar-action-btn" onclick="handleSignOut()">üö™ SIGN OUT</button>
  </div>
</div>

<div class="container" id="dashboard">
  <h2>Select Addiction</h2>
  <div class="card addiction-btn" onclick="openAddiction('Mobile & Social Media')">üì± Mobile & Social Media</div>
  <div class="card addiction-btn" onclick="openAddiction('Smoking / Alcohol')">üö¨ Smoking / Alcohol</div>
  <div class="card addiction-btn" onclick="openAddiction('Gaming')">üéÆ Gaming</div>
  <div class="card addiction-btn" onclick="openAddiction('Junk Food')">üçî Junk Food</div>
</div>

<div class="container" id="addictionPage" style="display:none">
  <button class="nav-btn" onclick="goBack()" style="margin-bottom:20px;">‚Üê Dashboard</button>
  
  <div class="stats-row">
      <div class="stat-circle">
          <span class="stat-value" id="widgetDay">1</span>
          <span class="stat-label">Day</span>
      </div>
      <div class="stat-circle" style="border-color: #e67e22;">
          <span class="stat-value" id="widgetStreak">0</span>
          <span class="stat-label">Streak</span>
      </div>
  </div>

  <div class="trophy-zone">
    <div class="shield-badge">üõ°Ô∏è <span id="shieldCount">0</span> Shields</div>
    <br>
    <svg width="120" height="120" viewBox="0 0 100 100" style="display:block; margin:0 auto;">
        <path d="M30,25 Q15,25 15,40 T30,50 M70,25 Q85,25 85,40 T70,50 M40,80 h20 M50,80 v10 M35,90 h30" fill="none" stroke="#d1ccbc" stroke-width="3"/>
        <path id="trophyPath" d="M30,20 h40 v30 c0,20 -10,30 -20,30 s-20,-10 -20,-30 z" fill="none" stroke="#d1ccbc" stroke-width="5"/>
    </svg>
    <h3 id="milestoneLabel" style="margin-top:10px;">Goal: Day 7</h3>
  </div>

  <div id="taskContent">
    <div id="specialTaskBox"></div>
    <h3 id="routineHeading">Today's Routine</h3>
    <div class="card" id="taskList"></div>
    <button class="update-btn" onclick="handleCompleteDay()">COMPLETE DAY</button>
    <button onclick="showWhyModal()" style="width:100%; margin-top:12px; background:transparent; border:2px solid var(--secondary); color:var(--secondary); padding:14px; border-radius:12px; font-weight:bold; cursor:pointer;">WHY THIS PLAN WORKS?</button>
  </div>

  <div id="successCard" class="card" style="display:none; text-align:center; background:var(--secondary); color:white;">
      <h2 id="successTitle">üåü Day Completed!</h2>
      <p style="opacity:0.9;">Great job! Your brain is healing.</p>
      <button class="update-btn" style="background:white; color:var(--secondary)" onclick="advanceToNextDay()">Start Next Day</button>
  </div>
</div>

<div id="warningModal" class="modal-overlay">
    <div class="modal-card">
        <h2 style="font-size: 50px; margin: 0;">‚ö†Ô∏è</h2>
        <h3>Tasks Incomplete</h3>
        <p>Please finish all your routine tasks before completing the day!</p>
        <button class="update-btn" onclick="hideWarning()">OK, I'LL DO IT</button>
    </div>
</div>

<div id="resetModal" class="modal-overlay"><div class="modal-card"><h3>Reset Everything?</h3><button class="update-btn" style="background:var(--danger); margin-bottom:10px;" onclick="handleConfirmReset()">YES, RESET</button><button class="nav-btn" onclick="hideResetModal()">CANCEL</button></div></div>
<div id="whyModal" class="modal-overlay"><div class="modal-card" style="width:400px; text-align:left;"><h3 style="margin-top:0;">üß† How This Helps</h3><div id="whyContent"></div><br><button class="update-btn" onclick="closeWhyModal()">CLOSE</button></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = { apiKey: "AIzaSyCKav6YcbmYnX0OkzdDabF3SonOKB_BW-s", authDomain: "nivaran-62268.firebaseapp.com", projectId: "nivaran-62268", storageBucket: "nivaran-62268.firebasestorage.app", messagingSenderId: "435713174677", appId: "1:435713174677:web:06f681ab823906f6ccff9c" };
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, async (user) => {
    if (!user && sessionStorage.getItem("guest") !== "true") window.location.replace("auth.html");
    if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
            const data = userDoc.data();
            document.getElementById('currentUserName').innerText = data.username || "User";
            document.getElementById('editName').value = data.username || "";
            document.getElementById('editHeight').value = data.height || "";
            document.getElementById('editWeight').value = data.weight || "";
            if(data.photo) document.getElementById('userAvatar').innerHTML = `<img src="${data.photo}">`;
        }
    }
});

/* üõ†Ô∏è TASK VALIDATION */
window.handleCompleteDay = () => {
    const checks = document.querySelectorAll('#taskList input[type="checkbox"]');
    const allDone = Array.from(checks).every(c => c.checked);
    if (checks.length > 0 && !allDone) {
        document.getElementById('warningModal').style.display = 'flex';
    } else {
        if(typeof window.markDone === 'function') window.markDone();
    }
};
window.hideWarning = () => document.getElementById('warningModal').style.display = 'none';

/* üõ†Ô∏è PROFILE LOGIC */
window.toggleProfileEdit = () => { const sec = document.getElementById('sidebarEditSection'); sec.style.display = (sec.style.display === 'none') ? 'block' : 'none'; };
window.previewSidebarImg = (input) => { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { document.getElementById('userAvatar').innerHTML = `<img src="${e.target.result}">`; window.pendingPhoto = e.target.result; }; reader.readAsDataURL(input.files[0]); } };
window.saveSidebarProfile = async () => {
    const user = auth.currentUser; if(!user) return;
    const updateData = { username: document.getElementById('editName').value, height: document.getElementById('editHeight').value, weight: document.getElementById('editWeight').value };
    if(window.pendingPhoto) updateData.photo = window.pendingPhoto;
    try { await updateDoc(doc(db, "users", user.uid), updateData); alert("Profile Updated!"); toggleProfileEdit(); } catch(e) { alert(e.message); }
};

window.handleSignOut = async () => { await signOut(auth); sessionStorage.removeItem("guest"); window.location.replace("auth.html"); };
window.showResetModal = () => document.getElementById('resetModal').style.display = 'flex';
window.hideResetModal = () => document.getElementById('resetModal').style.display = 'none';
window.handleConfirmReset = () => { localStorage.clear(); location.reload(); };
window.toggleSidebar = () => { sidebar.classList.toggle('open'); sidebarOverlay.style.display = sidebar.classList.contains('open') ? 'block' : 'none'; };
</script>

<script src="app.js"></script>
</body>
</html>
